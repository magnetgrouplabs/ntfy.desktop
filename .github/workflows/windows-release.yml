name: Windows Release Build

on:
  push:
    tags:
      - 'v*'

jobs:
  build-windows-release:
    name: Build Windows Release
    runs-on: windows-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable-x86_64-msvc
          target: x86_64-pc-windows-msvc

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "src-tauri -> target"

      - name: Install npm dependencies
        run: npm ci

      - name: Build with optimizations
        run: npm run tauri:build -- --release --verbose
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RUSTFLAGS: "-C target-cpu=native"

      - name: Create Windows Release
        uses: tauri-apps/tauri-action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'ntfy.desktop ${{ github.ref_name }}'
          releaseBody: |
            ## Windows Release
            
            **Windows Installers:**
            - `.msi` installer for system-wide installation
            - `-setup.exe` installer (NSIS-based)
            - Portable `.exe` executable
            
            ### System Requirements
            - Windows 10 or later
            - WebView2 runtime (automatically installed if missing)
            
            ### Installation
            1. Download the installer
            2. Run the `.msi` or `-setup.exe` file
            3. Follow the installation wizard
            
            For portable use, download the `.exe` file and run directly.
          releaseDraft: false
          prerelease: false
          args: ""

  validate-windows-installers:
    name: Validate Windows Installers
    runs-on: windows-latest
    needs: build-windows-release
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          name: tauri-release-${{ github.ref_name }}

      - name: Comprehensive installer validation
        shell: powershell
        run: |
          $installers = Get-ChildItem -Recurse -File | Where-Object { 
            $_.Extension -in @('.msi', '.exe') 
          }
          
          Write-Host "Validating $($installers.Count) Windows installer files..."
          
          foreach ($installer in $installers) {
            Write-Host "`nValidating $($installer.Name)..."
            
            # File size validation
            $sizeMB = [math]::Round($installer.Length / 1MB, 2)
            Write-Host "  Size: $sizeMB MB"
            
            if ($installer.Length -lt 1024) {
              Write-Host "  ❌ FAILED: File too small" -ForegroundColor Red
              exit 1
            }
            
            # File integrity check
            try {
              $stream = [System.IO.File]::OpenRead($installer.FullName)
              $buffer = New-Object byte[] 1024
              $bytesRead = $stream.Read($buffer, 0, 1024)
              $stream.Close()
              Write-Host "  ✅ File integrity: OK" -ForegroundColor Green
            } catch {
              Write-Host "  ❌ FAILED: File corrupted" -ForegroundColor Red
              exit 1
            }
            
            # PE header validation for executables
            if ($installer.Extension -eq '.exe') {
              try {
                $bytes = [System.IO.File]::ReadAllBytes($installer.FullName)
                if ($bytes[0] -eq 0x4D -and $bytes[1] -eq 0x5A) {
                  Write-Host "  ✅ PE header: Valid" -ForegroundColor Green
                } else {
                  Write-Host "  ⚠️ PE header: Unexpected" -ForegroundColor Yellow
                }
              } catch {
                Write-Host "  ⚠️ PE header: Could not validate" -ForegroundColor Yellow
              }
            }
          }
          
          Write-Host "`n✅ All Windows installer files validated successfully!" -ForegroundColor Green
