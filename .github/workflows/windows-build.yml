name: Windows Build

on:
  push:
    branches: [main, master]
    paths:
      - 'src-tauri/**'
      - 'src/**'
      - 'package.json'
      - 'tauri.conf.json'
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build-windows:
    name: Build Windows Application
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable-x86_64-msvc
          target: x86_64-pc-windows-msvc

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "src-tauri -> target"

      - name: Install npm dependencies
        run: npm ci

      - name: Verify Windows build environment
        shell: powershell
        run: |
          Write-Host "Windows SDK Check:"
          Get-ChildItem "C:\Program Files (x86)\Windows Kits" -ErrorAction SilentlyContinue | ForEach-Object { Write-Host "  - $($_.Name)" }
          
          Write-Host "Visual Studio Check:"
          Get-ChildItem "C:\Program Files\Microsoft Visual Studio" -ErrorAction SilentlyContinue | ForEach-Object { Write-Host "  - $($_.Name)" }
          
          Write-Host "WiX Toolset Check:"
          Get-Command heat.exe -ErrorAction SilentlyContinue
          Get-Command candle.exe -ErrorAction SilentlyContinue
          Get-Command light.exe -ErrorAction SilentlyContinue

      - name: Build Tauri application
        run: npm run tauri:build -- --verbose
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate Windows installer files
        shell: powershell
        run: |
          $bundlePath = "src-tauri/target/release/bundle"
          
          if (-not (Test-Path $bundlePath)) {
            Write-Error "Bundle directory not found at $bundlePath"
            exit 1
          }
          
          # Check for Windows installer files
          $msiFiles = Get-ChildItem -Path $bundlePath -Recurse -Filter "*.msi" -File
          $exeFiles = Get-ChildItem -Path $bundlePath -Recurse -Filter "*.exe" -File | 
            Where-Object { $_.Name -notlike "*setup*" }
          $setupFiles = Get-ChildItem -Path $bundlePath -Recurse -Filter "*setup.exe" -File
          
          Write-Host "Found Windows installer files:"
          
          if ($msiFiles.Count -gt 0) {
            Write-Host "  MSI Installers:" -ForegroundColor Green
            $msiFiles | ForEach-Object { 
              $sizeMB = [math]::Round($_.Length / 1MB, 2)
              Write-Host "    - $($_.Name) ($sizeMB MB)" 
            }
          }
          
          if ($setupFiles.Count -gt 0) {
            Write-Host "  Setup Executables:" -ForegroundColor Green
            $setupFiles | ForEach-Object { 
              $sizeMB = [math]::Round($_.Length / 1MB, 2)
              Write-Host "    - $($_.Name) ($sizeMB MB)" 
            }
          }
          
          if ($exeFiles.Count -gt 0) {
            Write-Host "  Portable Executables:" -ForegroundColor Green
            $exeFiles | ForEach-Object { 
              $sizeMB = [math]::Round($_.Length / 1MB, 2)
              Write-Host "    - $($_.Name) ($sizeMB MB)" 
            }
          }
          
          $totalFiles = $msiFiles.Count + $exeFiles.Count + $setupFiles.Count
          if ($totalFiles -eq 0) {
            Write-Error "No Windows installer files found"
            exit 1
          }
          
          Write-Host "Total installer files found: $totalFiles" -ForegroundColor Green

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-installers
          path: |
            src-tauri/target/release/bundle/**/*.msi
            src-tauri/target/release/bundle/**/*.exe
            src-tauri/target/release/ntfy-desktop.exe
          retention-days: 30

      - name: Upload portable executable
        uses: actions/upload-artifact@v4
        with:
          name: windows-portable
          path: src-tauri/target/release/ntfy-desktop.exe
          retention-days: 30

  test-windows:
    name: Test Windows Build
    runs-on: windows-latest
    needs: build-windows
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-installers

      - name: Validate installer functionality
        shell: powershell
        run: |
          # Check file integrity
          $installers = Get-ChildItem -Recurse -File | Where-Object { 
            $_.Extension -in @('.msi', '.exe') 
          }
          
          Write-Host "Validating $($installers.Count) installer files..."
          
          foreach ($installer in $installers) {
            Write-Host "Checking $($installer.Name)..." -NoNewline
            
            # Basic file validation
            if ($installer.Length -lt 1024) {
              Write-Host " FAILED (file too small)" -ForegroundColor Red
              exit 1
            }
            
            # Check if file is readable
            try {
              $stream = [System.IO.File]::OpenRead($installer.FullName)
              $stream.Close()
              Write-Host " OK" -ForegroundColor Green
            } catch {
              Write-Host " FAILED (file corrupted)" -ForegroundColor Red
              exit 1
            }
          }
          
          Write-Host "All installer files validated successfully!" -ForegroundColor Green
